<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Plex Playlist Manager</title>
    <!-- Imports -->
    {% include 'css_imports.html' %}
    {% include 'js_imports.html' %}
</head>
<body>
    <div class="wrapper">
        <!-- Sidebar  -->
        <nav id="sidebar">
            <div class="sidebar-header">
                <h3>Plex Playlist Manager</h3>
                <strong>BS</strong>
            </div>
            <ul class="list-unstyled components">
                <div class="sidebar">
                    {% for playlist_type, playlists in playlists_by_type.items() %}
                        <div class="sidebar-playlist-type-card">
                            <div class="playlist-type-card-header" id="heading{{ loop.index }}" data-toggle="collapse" data-target="#collapse{{ loop.index }}" aria-expanded="true" aria-controls="collapse{{ loop.index }}">
                                <h5 class="mb-0">
                                    <p>
                                        {% if playlist_type == 'audio' %}
                                            <i class="fas fa-music" style="margin-right: 10px;"></i>
                                        {% elif playlist_type == 'video' %}
                                            <i class="fas fa-video" style="margin-right: 10px;"></i>
                                        {% elif playlist_type == 'photo' %}
                                            <i class="fas fa-image" style="margin-right: 10px;"></i>
                                        {% else %}
                                            <i class="fas fa-list" style="margin-right: 10px;"></i>
                                        {% endif %}
                                        {{ playlist_type|capitalize }}
                                    </p>
                                </h5>
                            </div>
                            <div id="collapse{{ loop.index }}" class="collapse" aria-labelledby="heading{{ loop.index }}" data-parent=".sidebar">
                                <div class="playlist-container">
                                    <ul>
                                        {% for playlist in playlists %}
                                            <div class="playlist-item">
                                                <li>{{ playlist.name }}</li>
                                            </div>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </ul>
        </nav>

        <!-- Page Content  -->
        <div id="content">
            <!-- Navbar content here -->
            <nav class="navbar navbar-expand-lg navbar-light bg-light">
                <div class="container-fluid">
                    <form class="form-inline my-2 my-lg-0 ml-auto">
                        <input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search">
                    </form>
                </div>
            </nav>
            <!-- Add Playlist contents -->
            <div id="media_container">
                <div id="playlist_data_container" class="accordion"></div>
            </div>
        </div>
    </div>

    <!-- jQuery CDN -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <!-- Popper.JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
    <!-- Bootstrap JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script>

    <!-- Our Custom Scripts -->
    <script>
        $(document).ready(function() {
            // Handle playlist item click event
            $('.playlist-item li').click(function() {
                var playlistName = $(this).text().trim();

                // Fetch playlist data from the server
                $.getJSON('/get_playlist', { name: playlistName }, function(data) {
                    if (data.error) {
                        alert('Playlist not found');
                    } else {
                        renderPlaylistData(data.items);
                    }
                });
            });

            // Function to render playlist data
            function renderPlaylistData(items) {
                var container = $('#playlist_data_container');
                container.empty();

                // Render grouped items as text
                var renderedData = renderNestedData(items, 0);
                container.append(renderedData);
            }

            // Function to render nested data
            function renderNestedData(data, level) {
                var html = '<ul>';
                // data is now a list of tuples
                data.forEach(function(item) {
                    var key = item[0];
                    var value = item[1];
                    console.log(key);
                    html += `<li style="margin-left: ${level * 20}px"><strong>${key}:</strong>`;
                    if (Array.isArray(value)) {
                        html += `<ul>`;
                        value.forEach(function(subItem) {
                            html += `<li style="margin-left: ${(level + 1) * 20}px">${subItem}</li>`;
                        });
                        html += `</ul>`;
                    } else if (typeof value === 'object' && value !== null) {
                        html += renderNestedData(Object.entries(value), level + 1);
                    } else {
                        html += ` ${value}`;
                    }
                    html += `</li>`;
                });
                html += '</ul>';
                return html;
            }
        });
    </script>

</body>
</html>
